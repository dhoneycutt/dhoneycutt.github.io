<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>ALT</title>
</head>
<body>
    <link rel="stylesheet" href="styles.css" />
    <div id="canvas">
        <img id="imageID" style="max-height:100%; max-width: 100%" draggable="false" user-select="none" />
    </div>
    <br />
    <p class="centerP">
        System Prediction: <input id="sysPred" type="text" value="" disabled /> Your Answer: <input id="userVal" type="text" value="" disabled />
    </p>
    <br />
    <p class="centerP">
        Place bounding boxes around all faces. Click once to start placing a box, then click again to place the box (do not click and drag).
    </p>
    <br />
        <!--<button id="prevBtn" class="btn" onclick="prevImg()">Previous Image</button>-->
    <p class="centerP">
        <button id="resetBtn" class="btn" onclick="resetBoxes()">Reset Changes</button>
        <button id="nextBtn" class="btn" onclick="nextImg()">Next Image</button>
    </p>
        <!--<button id="clearBtn" class="btn" onclick="clearBoxes()">Clear Boxes</button>-->
    <script src="boxes.js"></script>
</body>
</html>

<script>
    var i = 0;
    var idVar = 0
    var numBoxes = 0
    var numFiles = 30;
    var iteration = getUrlVars()["i"]
    document.getElementById("imageID").src = "images_" + iteration + "/0.jpg"
    initBoxes(iteration, 0)
    initDraw(document.getElementById('canvas'));

    function initBoxes(itr, img) {
        var boxes = iterationArray[itr][img]
        for (j = 0; j < boxes.length; j++) {
            element = document.createElement('div');
            element.className = 'rectangle'
            element.id = idVar + 'box'
            element.draggable = 'false'
            element.style.left = boxes[j].left;
            element.style.top = boxes[j].top;
            element.style.width = boxes[j].width;
            element.style.height = boxes[j].height;
            element.onmousemove = function (e) {
                setMousePosition(e);
                if (element !== null) {
                    element.style.width = Math.abs(mouse.x - mouse.startX) + 'px';
                    element.style.height = Math.abs(mouse.y - mouse.startY) + 'px';
                    element.style.left = (mouse.x - mouse.startX < 0) ? mouse.x + 'px' : mouse.startX + 'px';
                    element.style.top = (mouse.y - mouse.startY < 0) ? mouse.y + 'px' : mouse.startY + 'px';
                }
            }
            canvas.appendChild(element)
            numBoxes++
            closeButton = document.createElement('button')
            closeButton.className = 'closeButton'
            closeButton.id = idVar + 'btn'
            closeButton.draggable = 'false'
            closeButton.style.left = parseInt(element.style.left) + parseInt(element.style.width) - 3 + 'px'
            closeButton.style.top = parseInt(element.style.top) - 10 + 'px'
            closeButton.innerText = "X"
            //closeButton.style.width = "10px"
            //closeButton.style.height = "10px"
            closeButton.style.fill = "blue"
            closeButton.onclick = function (e) {
                btnID = this.id
                boxID = parseInt(this.id) + 'box'

                document.getElementById(btnID).remove()
                document.getElementById(boxID).remove()
                numBoxes--
                document.getElementById("userVal").value = numBoxes
            }
            closeButton.onmousemove = function (e) {
                setMousePosition(e);
                if (element !== null) {
                    element.style.width = Math.abs(mouse.x - mouse.startX) + 'px';
                    element.style.height = Math.abs(mouse.y - mouse.startY) + 'px';
                    element.style.left = (mouse.x - mouse.startX < 0) ? mouse.x + 'px' : mouse.startX + 'px';
                    element.style.top = (mouse.y - mouse.startY < 0) ? mouse.y + 'px' : mouse.startY + 'px';
                }
            }
            canvas.appendChild(closeButton)
            idVar++
            element = null


        }
        document.getElementById("userVal").value = numBoxes
        document.getElementById("sysPred").value = numBoxes
    }

    function resetBoxes() {
        clearBoxes()
        initBoxes(iteration, i)
    }

    function nextImg() {
        if (i == numFiles - 1) {
            alert("Last image")
        }
        else {
            i++
            document.getElementById("imageID").src = "images_" + iteration + "/" + i + ".jpg"
            document.getElementById("userVal").value = ""
            clearBoxes()
            initBoxes(iteration, i)
        }
    }
    function prevImg() {
        if (i == 1) {
            alert("First image")
        }
        else {
            i--
            document.getElementById("imageID").src = "images/" + i + ".jpg"
            document.getElementById("userVal").value = ""
            clearBoxes()
        }
    }

    function clearBoxes() {
        var boxes = document.getElementsByClassName('rectangle')
        while (boxes[0]) {
            boxes[0].remove()
        }
        var buttons = document.getElementsByClassName('closeButton')
        while (buttons[0]) {
            buttons[0].remove()
        }
        numBoxes = 0
    }

    function initDraw(canvas) {
        function setMousePosition(e) {
            var ev = e || window.event; //Moz || IE
            if (ev.pageX) { //Moz
                mouse.x = ev.pageX + window.pageXOffset;
                mouse.y = ev.pageY + window.pageYOffset;
            } else if (ev.clientX) { //IE
                mouse.x = ev.clientX + document.body.scrollLeft;
                mouse.y = ev.clientY + document.body.scrollTop;
            }
        };

        var mouse = {
            x: 0,
            y: 0,
            startX: 0,
            startY: 0
        };
        var element = null;

        imageID.onmousemove = function (e) {
            setMousePosition(e);
            if (element !== null) {
                element.style.width = Math.abs(mouse.x - mouse.startX) + 'px';
                element.style.height = Math.abs(mouse.y - mouse.startY) + 'px';
                element.style.left = (mouse.x - mouse.startX < 0) ? mouse.x + 'px' : mouse.startX + 'px';
                element.style.top = (mouse.y - mouse.startY < 0) ? mouse.y + 'px' : mouse.startY + 'px';
            }
        }

        imageID.onmousedown = function (e) {
            console.log("begun.");
            mouse.startX = mouse.x;
            mouse.startY = mouse.y;
            element = document.createElement('div');
            element.className = 'rectangle'
            element.id = idVar + 'box'
            element.draggable = 'false'
            element.style.left = mouse.x + 'px';
            element.style.top = mouse.y + 'px';
            element.onmouseup = function (e) {
                if (element != null) {
                    if (element.style.width == "" || element.style.height == "") {
                        element.remove()
                    }
                    else {

                        //Create circle

                        //closeButton = document.createElement('div');
                        //closeButton.className = 'circle'
                        //closeButton.id = 'circle' + idVar
                        //closeButton.draggable = 'false'
                        //closeButton.style.cx = element.style.left
                        //closeButton.style.cy = element.style.top
                        //closeButton.style.r = '400px'
                        //closeButton.style.fill = "blue"
                        //canvas.appendChild(closeButton)
                        closeButton = document.createElement('button')
                        closeButton.className = 'closeButton'
                        closeButton.id = idVar + 'btn'
                        closeButton.draggable = 'false'
                        closeButton.style.left = parseInt(element.style.left) + parseInt(element.style.width) - 3 + 'px'
                        closeButton.style.top = parseInt(element.style.top) - 10 + 'px'
                        closeButton.innerText = "X"
                        //closeButton.style.width = "10px"
                        //closeButton.style.height = "10px"
                        closeButton.style.fill = "blue"
                        closeButton.onclick = function (e) {
                            btnID = this.id
                            boxID = parseInt(this.id) + 'box'

                            document.getElementById(btnID).remove()
                            document.getElementById(boxID).remove()

                            numBoxes--
                            document.getElementById("userVal").value = numBoxes
                        }
                        closeButton.onmousemove = function (e) {
                            setMousePosition(e);
                            if (element !== null) {
                                element.style.width = Math.abs(mouse.x - mouse.startX) + 'px';
                                element.style.height = Math.abs(mouse.y - mouse.startY) + 'px';
                                element.style.left = (mouse.x - mouse.startX < 0) ? mouse.x + 'px' : mouse.startX + 'px';
                                element.style.top = (mouse.y - mouse.startY < 0) ? mouse.y + 'px' : mouse.startY + 'px';
                            }
                        }
                        canvas.appendChild(closeButton)

                        console.log(element)
                        console.log(closeButton)

                        idVar++
                        numBoxes++
                        document.getElementById("userVal").value = numBoxes

                        element = null;
                        canvas.style.cursor = "default";
                        console.log("finished.");
                    }
                }
            }
            element.onmousemove = function (e) {
                setMousePosition(e);
                if (element !== null) {
                    element.style.width = Math.abs(mouse.x - mouse.startX) + 'px';
                    element.style.height = Math.abs(mouse.y - mouse.startY) + 'px';
                    element.style.left = (mouse.x - mouse.startX < 0) ? mouse.x + 'px' : mouse.startX + 'px';
                    element.style.top = (mouse.y - mouse.startY < 0) ? mouse.y + 'px' : mouse.startY + 'px';
                }
            }
            canvas.appendChild(element)
            canvas.style.cursor = "crosshair";
         
        }
    }

    function getUrlVars() {
        var vars = {};
        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
            vars[key] = value;
        });
        return vars;
    }
</script>